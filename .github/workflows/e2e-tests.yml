name: E2E Tests

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      browser:
        description: 'Browser to test (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - chromium
          - firefox
          - webkit

jobs:
  test:
    name: E2E Tests (${{ matrix.browser }}, shard ${{ matrix.shard }}/4)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        shard: [1, 2, 3, 4]
        exclude:
          # If manual dispatch with specific browser, exclude others
          - browser: ${{ github.event.inputs.browser != '' && github.event.inputs.browser != 'chromium' && 'chromium' || 'none' }}
          - browser: ${{ github.event.inputs.browser != '' && github.event.inputs.browser != 'firefox' && 'firefox' || 'none' }}
          - browser: ${{ github.event.inputs.browser != '' && github.event.inputs.browser != 'webkit' && 'webkit' || 'none' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Get Playwright version
        id: playwright-version
        working-directory: frontend
        run: echo "version=$(npm list @playwright/test --depth=0 | grep @playwright/test | sed 's/.*@//')" >> $GITHUB_OUTPUT

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}-${{ matrix.browser }}
          restore-keys: |
            playwright-${{ runner.os }}-${{ steps.playwright-version.outputs.version }}-
            playwright-${{ runner.os }}-

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps ${{ matrix.browser }}
        if: steps.playwright-cache.outputs.cache-hit != 'true'

      - name: Install system dependencies only
        working-directory: frontend
        run: npx playwright install-deps ${{ matrix.browser }}
        if: steps.playwright-cache.outputs.cache-hit == 'true'

      - name: Start frontend dev server
        working-directory: frontend
        run: |
          npm run dev &
          # Wait for server to be ready (max 60s)
          for i in {1..60}; do
            if curl -s http://localhost:5173 > /dev/null; then
              echo "Dev server is ready"
              exit 0
            fi
            echo "Waiting for dev server... ($i/60)"
            sleep 1
          done
          echo "Dev server failed to start"
          exit 1

      - name: Run E2E tests
        working-directory: frontend
        run: npx playwright test --project=${{ matrix.browser }} --shard=${{ matrix.shard }}/4
        env:
          CI: true
          PLAYWRIGHT_TEST_BASE_URL: http://localhost:5173

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-results-${{ matrix.browser }}-${{ matrix.shard }}
          path: frontend/test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.browser }}-${{ matrix.shard }}
          path: frontend/blob-report/
          retention-days: 7
          if-no-files-found: ignore

  merge-reports:
    name: Merge Test Reports
    if: always()
    needs: [test]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Download all blob reports
        uses: actions/download-artifact@v4
        with:
          path: all-blob-reports
          pattern: blob-report-*
          merge-multiple: true

      - name: Merge reports
        working-directory: frontend
        run: npx playwright merge-reports --reporter html ../all-blob-reports

      - name: Upload merged HTML report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report/
          retention-days: 14

      - name: Generate summary
        if: always()
        run: |
          echo "## E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "View the full HTML report in the artifacts section." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Matrix" >> $GITHUB_STEP_SUMMARY
          echo "- Browsers: chromium, firefox, webkit" >> $GITHUB_STEP_SUMMARY
          echo "- Shards: 4 per browser (12 total jobs)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Some tests failed. Check the artifacts for details." >> $GITHUB_STEP_SUMMARY
          fi

  # Optional: Comment on PR with results
  comment-pr:
    name: Comment on PR
    if: always() && github.event_name == 'pull_request'
    needs: [test, merge-reports]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write

    steps:
      - name: Create PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const testResult = '${{ needs.test.result }}';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;

            let emoji = testResult === 'success' ? '✅' : '❌';
            let status = testResult === 'success' ? 'passed' : 'failed';

            const comment = `## ${emoji} E2E Tests ${status}

            **Test Matrix:** 3 browsers × 4 shards = 12 parallel jobs

            - **Browsers:** chromium, firefox, webkit
            - **Status:** ${status}

            [View detailed results](${runUrl})

            ---
            *Automated E2E testing with Playwright*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
